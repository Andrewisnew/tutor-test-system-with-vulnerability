package config;

import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;
import services.api.UserService;
import services.impl.UserServiceImpl;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import java.sql.Connection;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ResourceBundle;

public class InitDB extends HttpServlet {

    private final static Logger log = LogManager.getLogger(InitDB.class);
    private static final String SQL_QUERIES = "sql_queries";
    private static final String CREATE_USER = "create.user";
    private static final String CREATE_TEST = "create.test";
    private static final String CREATE_QUESTION = "create.question";
    private static final String CREATE_ANSWER = "create.answer";
    private static final String CREATE_TESTRESULT = "create.testresult";
    private static final String CREATE_USER_TUTOR = "create.user.tutor";
    private UserService userService = new UserServiceImpl();
    @Override
    public void init() throws ServletException {
        super.init();
        Statement st = null;
        Connection con = null;
        try {
            Class.forName ("org.postgresql.Driver");
            ConnectionPool pool = ConnectionPool.getInstance();
            con = pool.getConnection();
            ResourceBundle res = ResourceBundle.getBundle(SQL_QUERIES);
            String[] sqls = {res.getString(CREATE_USER),
                    res.getString(CREATE_TEST),
                    res.getString(CREATE_QUESTION),
                    res.getString(CREATE_ANSWER),
                    res.getString(CREATE_TESTRESULT)};
            st = con.createStatement();
            for (String sql : sqls) {
                st.executeUpdate(sql);
            }
            if(userService.get("tutor") == null){
                st.executeUpdate(res.getString(CREATE_USER_TUTOR));
            }
            log.info("Database successfully initialized");
        } catch (SQLException e) {
            log.error("Database didn't initialize", e);
            throw new RuntimeException(e);
        } catch (ClassNotFoundException e) {
            e.printStackTrace();
        } finally {
            try {
                if (st != null)
                    st.close();
                if (con != null)
                    ConnectionPool.freeConnection(con);
            } catch (SQLException e) {
                log.error("Database didn't initialize", e);
            }
        }
    }
}
